<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>صفحة الاستعلام عن بيانات المدارس</title>

  <!-- خطوط وأيقونات عبر HTTPS -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha384-1C3Fe2k3k5Xk2Gr0cQ7mXnqY8u0v6KX1fO5L3QX3kqzDk3x0d9Qq1rQ8rG5H1NfW" crossorigin="anonymous"/>

  <style>
    /* ألوان الهوية (مطابقة للهيدر الخارجي) */
    :root{
      --moe-dark:#006e6a;
      --moe:#00907f;
      --moe-light:#00b49f;

      --surface:#e6f7f5;       /* خلفية فاتحة مائلة للفيروزي */
      --text-main:#0b5c57;     /* لون نص أساسي */
    }

    /* تثبيت الفوتر بأسلوب Flex */
    html, body { height: 100%; }
    body {
      display: flex;
      flex-direction: column;
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom right, var(--surface), #ffffff);
      color: var(--text-main);
      padding: 20px;
    }

    /* مناطق الإدراج */
    #header, #footer { width: 100%; }
    main { flex: 1; display: block; }

    /* عنوان داخلي (بديل عن الهيدر القديم كي لا يتكرر) */
    .page-title{
      background-color: var(--surface);
      color: var(--text-main);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      margin: 12px auto 20px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
      max-width: 980px;
    }
    .page-title h1{ margin:0; font-size:22px; }
    .page-title h2{ margin:6px 0 0; font-size:15px; font-weight:600; color:#0f766e; }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 10px;
      align-items: center;
      background-color: var(--surface);
      border-radius: 12px;
      padding: 10px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin-inline: auto;
    }

    .top-bar button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background-color: var(--moe);   /* موحّد مع الهيدر */
      color: white;
      font-size: 15px;
      cursor: pointer;
      transition: transform .06s ease, background-color .25s ease, box-shadow .25s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .top-bar button:hover { background-color: var(--moe-dark); }
    .top-bar button:active { transform: translateY(1px); }

    /* توحيد لون الأيقونات */
    .top-bar i { color: #fff; }               /* داخل الأزرار أبيض */
    #userInfo i { color: var(--moe-dark); }   /* بجانب اسم المستخدم */
    .fa, .fas, .far, .fal, .fab { vertical-align: -1px; }

    #userInfo {
      background-color: var(--surface);
      color: var(--text-main);
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex; align-items: center; gap: 10px;
    }

    .search-container {
      max-width: 800px;
      margin: 20px auto 0;
      background: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    input, select {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #bdbdbd;
      margin: 6px;
      font-size: 15px;
      max-width: 320px;
      width: 100%;
    }
    input:focus, select:focus{
      outline: none; border-color: var(--moe);
      box-shadow: 0 0 0 3px rgba(0,144,127,.12);
    }

    .table-container { max-height: 500px; overflow: auto; margin-top: 20px; }
    table {
      border-collapse: collapse; width: 100%; table-layout: fixed;
      font-size: 14px; min-width: 1000px; background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    th {
      position: sticky; top: 0; background: var(--moe-dark); color: white; padding: 10px; z-index: 1;
    }
    td {
      white-space: normal; word-break: break-word; padding: 10px;
      border: 1px solid #e0e0e0; text-align: center; vertical-align: middle;
    }
    tr:nth-child(even) { background-color: #edf9f7; } /* صفوف متناوبة بلون فيروزي فاتح */

    #totalCount { text-align: center; font-weight: bold; margin-bottom: 20px; color: var(--moe-dark); }
    #tooShort { color:#c62828; font-weight:bold; display:none; }
    #loadingMessage { color:#b45309; display:none; }
    #schoolCount { display:none; }
    #noResults { display:none; color:#b91c1c; text-align:center; font-weight:bold; }
  </style>
</head>
<body>
  <!-- إدراج الهيدر من ملف خارجي -->
  <div id="header"></div>

  <main>
    <!-- عنوان داخلي فقط (لم يعد هيدرًا ثانيًا) -->
    <div class=>
   

    </div>

    <div class="top-bar">
      <div id="userInfo">
        <i class="fas fa-user-circle"></i>
        <span>المستخدم: <strong id="userNameLabel">...</strong> | الصلاحية: <strong id="userRoleLabel">...</strong></span>
      </div>
      <div>
        <button onclick="window.open('https://ali71425.github.io/school-data-page/', '_blank')">
          <i class="fas fa-chart-line"></i> الداشبورد
        </button>
        <button onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
        </button>
      </div>
    </div>

    <div class="search-container">
      <select id="sectorFilter"><option value="">📍 الكل - القطاع</option></select>
      <select id="typeFilter"><option value="">🏫 الكل - النوع</option></select>
      <input id="searchInput" type="text" placeholder="🔎 أدخل 3 أحرف أو أكثر"/>
      <div id="tooShort">⚠️ أدخل 3 أحرف أو أرقام على الأقل</div>
      <div id="loadingMessage">⏳ جاري البحث...</div>
      <div id="schoolCount">عدد النتائج: <span id="countValue"></span></div>
    </div>

    <div class="table-container">
      <table id="resultsTable" style="display:none;">
        <thead>
          <tr>
            <th>الرقم الإحصائي</th><th>القطاع</th><th>المكتب</th><th>النوع</th><th>اسم المدرسة</th>
            <th>اسم المدير/ة</th><th>رقم الجوال</th><th>اسم المنسق/ة</th><th>جوال المنسق/ة</th>
            <th>حالة التأكيد</th><th>الملاحظات</th><th>تاريخ التأكيد</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="noResults">❌ لا توجد نتائج مطابقة</div>
    </div>
  </main>

  <!-- إدراج الفوتر من ملف خارجي -->
  <div id="footer"></div>

  <script>
    // تحميل الهيدر والفوتر من ملفات خارجية مع تعامل أخطاء بسيط
    document.addEventListener('DOMContentLoaded', () => {
      fetch('header.html', {cache: 'no-cache'})
        .then(r => r.ok ? r.text() : Promise.reject(r.status))
        .then(html => { document.getElementById('header').innerHTML = html; })
        .catch(err => console.warn('تعذر تحميل الهيدر:', err));

      fetch('footer.html', {cache: 'no-cache'})
        .then(r => r.ok ? r.text() : Promise.reject(r.status))
        .then(html => { document.getElementById('footer').innerHTML = html; })
        .catch(err => console.warn('تعذر تحميل الفوتر:', err));

      // تهيئة بيانات المستخدم
      const userName = sessionStorage.getItem("userName") || "غير معروف";
      const userRole = sessionStorage.getItem("userRole") || "مستخدم";
      document.getElementById("userNameLabel").textContent = userName;
      document.getElementById("userRoleLabel").textContent = userRole;

      // بحث بالإنتر
      document.getElementById("searchInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") filterResults();
      });

      // التحكم في التحقق والداتا
      if (sessionStorage.getItem("authenticated") === "true") {
        fetchSchoolData();
        document.getElementById("searchInput").addEventListener("input", filterResults);
        document.getElementById("sectorFilter").addEventListener("change", filterResults);
        document.getElementById("typeFilter").addEventListener("change", filterResults);
      } else {
        const loginOverlay = document.createElement("div");
        loginOverlay.id = "loginOverlay";
        loginOverlay.style = "position:fixed;inset:0;background-color:rgba(248,249,250,.98);z-index:9999;display:flex;align-items:center;justify-content:center;";
        loginOverlay.innerHTML = `
          <div style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.15);text-align:center;max-width:400px;width:100%;">
            <h2 style="color:#006c35;margin-bottom:20px;">🔐 تسجيل الدخول</h2>
            <input id="userCodeInput" type="text" placeholder="أدخل رقم المستخدم" style="padding:12px;font-size:16px;width:100%;margin-bottom:10px;border:1px solid #ccc;border-radius:6px;"/>
            <button id="loginBtn" style="background-color:#006c35;color:#fff;padding:12px 20px;font-size:16px;border:none;border-radius:6px;cursor:pointer;">دخول</button>
            <p id="loginError" style="color:red;margin-top:10px;display:none;">❌ الرقم غير مصرح به</p>
          </div>
        `;
        document.body.appendChild(loginOverlay);
        document.getElementById('loginBtn').addEventListener('click', verifyUserCode);
      }
    });

    // جلب البيانات والفلترة (كما في كودك الأصلي)
    let schoolData = [];
    function fetchSchoolData() {
      document.getElementById("loadingMessage").style.display = 'block';
      fetch('https://script.google.com/macros/s/AKfycbwmLZXbtQQuIui6c-zQTjQDsT4OPFM_YWWR3taupQ5A2hUg0TWXyZRBsxvsc56uMrDc/exec')
        .then(response => response.json())
        .then(data => {
          schoolData = data.schools || [];
          populateFilters(schoolData);
          displayResults(schoolData);
          document.getElementById("loadingMessage").style.display = 'none';
        })
        .catch(() => {
          document.getElementById("loadingMessage").textContent = "⚠️ تعذر تحميل البيانات.";
        });
    }
    function populateFilters(data) {
      const sectors = new Set(), types = new Set();
      data.forEach(r => { if (r.القطاع) sectors.add(r.القطاع); if (r.النوع) types.add(r.النوع); });
      const sectorSelect = document.getElementById("sectorFilter");
      const typeSelect = document.getElementById("typeFilter");
      sectors.forEach(sec => { const o=document.createElement("option"); o.value=sec; o.textContent=sec; sectorSelect.appendChild(o); });
      types.forEach(type => { const o=document.createElement("option"); o.value=type; o.textContent=type; typeSelect.appendChild(o); });
    }
    function displayResults(data) {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = "";
      if (!data.length) {
        document.getElementById("resultsTable").style.display = "none";
        document.getElementById("noResults").style.display = "block";
        document.getElementById("schoolCount").style.display = "none";
        return;
      }
      data.forEach(row => {
        const tr = document.createElement("tr");
        ['الرقم الإحصائي','القطاع','المكتب','النوع','اسم المدرسة','اسم المدير/ة','رقم الجوال','اسم المنسق/ة','جوال المنسق/ة','حالة التأكيد','الملاحظات','تاريخ التأكيد']
        .forEach(key => { const td=document.createElement("td"); td.textContent=row[key]||''; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      document.getElementById("resultsTable").style.display = "table";
      document.getElementById("noResults").style.display = "none";
      document.getElementById("schoolCount").style.display = "block";
      document.getElementById("countValue").textContent = data.length;
    }
    function filterResults() {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const sector = document.getElementById("sectorFilter").value;
      const type = document.getElementById("typeFilter").value;
      if (q.length>0 && q.length<3) {
        document.getElementById("tooShort").style.display = 'block';
        document.getElementById("resultsTable").style.display = "none";
        document.getElementById("schoolCount").style.display = "none";
        document.getElementById("noResults").style.display = "none";
        return;
      } else { document.getElementById("tooShort").style.display = 'none'; }
      const filtered = schoolData.filter(row => {
        const matchQuery = q.length<3 || Object.values(row).some(v => v && String(v).toLowerCase().includes(q));
        const matchSector = !sector || row["القطاع"] === sector;
        const matchType   = !type   || row["النوع"] === type;
        return matchQuery && matchSector && matchType;
      });
      displayResults(filtered);
    }
    function verifyUserCode() {
      const userCode = document.getElementById("userCodeInput").value.trim();
      fetch(`https://script.google.com/macros/s/AKfycbwmLZXbtQQuIui6c-zQTjQDsT4OPFM_YWWR3taupQ5A2hUg0TWXyZRBsxvsc56uMrDc/exec?code=${encodeURIComponent(userCode)}`)
        .then(r => r.json())
        .then(data => {
          if (data.status === 'ok') {
            sessionStorage.setItem("authenticated", "true");
            sessionStorage.setItem("userName", data.name);
            sessionStorage.setItem("userRole", data.role);
            sessionStorage.setItem("userSchool", data.schoolCode);
            sessionStorage.setItem("loginTime", Date.now());
            location.reload();
          } else {
            document.getElementById("loginError").style.display = 'block';
          }
        })
        .catch(()=>{ document.getElementById("loginError").style.display='block'; });
    }
    function logout(){ sessionStorage.clear(); location.reload(); }
  </script>
</body>
</html>
